version: "3.8"

volumes:
  subgraphs_data:

networks:
  reverse_proxy:
    external: true

services:
  mongo:
    image: mongo:4.4.18
    volumes:
      - /mnt/share/mongo_stage:/data/db
    env_file:
      - $CC_CONFIG_PATH/prod/global

  gateway:
    image: cc-gateway:latest
    volumes:
      - subgraphs_data:/subgraphs
    env_file:
      - $CC_CONFIG_PATH/prod/global
      - $CC_CONFIG_PATH/prod/gateway
    depends_on:
      - interfaces
      - clubs
      - events
      - users

  nginx:
    build: ./nginx
    volumes:
      - ./nginx:/etc/nginx/conf.d
    depends_on:
      - auth
      - files
      - gateway
      - web
    environment:
      - VIRTUAL_HOST=clubs.iiit.ac.in
      - LETSENCRYPT_HOST=clubs.iiit.ac.in
    networks:
      - default
      - reverse_proxy

  feeder:
    image: cc-feeder:latest
    volumes:
      - ./data:/data
    depends_on:
      - mongo
    env_file:
      - $CC_CONFIG_PATH/prod/global

  web:
    image: cc-web:latest
    env_file:
      - $CC_CONFIG_PATH/prod/web

  auth:
    image: cc-auth:latest
    env_file:
      - $CC_CONFIG_PATH/prod/global
      - $CC_CONFIG_PATH/prod/auth

  files:
    image: cc-files:latest
    volumes:
      - /mnt/share/files1:/files
    env_file:
      - $CC_CONFIG_PATH/prod/global
      - $CC_CONFIG_PATH/prod/files

  # subgraphs
  interfaces:
    image: cc-interfaces:latest
    volumes:
      - subgraphs_data:/subgraphs
    depends_on:
      - mongo
    env_file:
      - $CC_CONFIG_PATH/prod/global
      - $CC_CONFIG_PATH/prod/interfaces

  clubs:
    image: cc-clubs:latest
    volumes:
      - subgraphs_data:/subgraphs
    depends_on:
      - mongo
    env_file:
      - $CC_CONFIG_PATH/prod/global

  events:
    image: cc-events:latest
    volumes:
      - subgraphs_data:/subgraphs
    depends_on:
      - mongo
    env_file:
      - $CC_CONFIG_PATH/prod/global

  users:
    image: cc-users:latest
    volumes:
      - subgraphs_data:/subgraphs
    depends_on:
      - mongo
    env_file:
      - $CC_CONFIG_PATH/prod/global
