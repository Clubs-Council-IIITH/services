volumes:
  subgraphs_data:

networks:
  reverse_proxy:
    ipam:
        config:
          - subnet:  172.19.0.0/24
#     external: true

services:
  mongo:
    image: mongo:4.4
    volumes:
      - /mnt/share/mongo:/data/db
    env_file:
      - $CC_CONFIG_PATH/prod/global
    restart: unless-stopped

  gateway:
    # image: cc-gateway:latest
    build: ./gateway
    volumes:
      - subgraphs_data:/subgraphs:ro
    env_file:
      - $CC_CONFIG_PATH/prod/global
      - $CC_CONFIG_PATH/prod/gateway
    environment:
      - NODE_ENV=production
    depends_on:
      - interfaces
      - clubs
      - members
      - events
      - users
    restart: unless-stopped

  nginx:
    build: ./nginx
    volumes:
      - ./nginx:/etc/nginx/conf.d
    depends_on:
      - auth
      - files
      - gateway
      - web
    environment:
      - VIRTUAL_HOST=clubs.iiit.ac.in
      - LETSENCRYPT_HOST=clubs.iiit.ac.in
    networks:
      default:
      reverse_proxy:
          ipv4_address: 172.19.0.4
    restart: unless-stopped

  # feeder:
  #   image: cc-feeder:latest
  #   volumes:
  #     - ./data:/data
  #   depends_on:
  #     - mongo
  #   env_file:
  #     - $CC_CONFIG_PATH/prod/global
  #   restart: no

  web:
    # image: cc-web:latest
    build:
      context: ./web
    env_file:
      - $CC_CONFIG_PATH/prod/global
      - $CC_CONFIG_PATH/prod/web
    restart: unless-stopped

  auth:
    # image: cc-auth:latest
    build: ./apis/auth
    env_file:
      - $CC_CONFIG_PATH/prod/global
      - $CC_CONFIG_PATH/prod/auth
    volumes:
      - ./config:/app/config
    restart: unless-stopped

  files:
    # image: cc-files:latest
    build: ./apis/files
    volumes:
      - /mnt/share/files1:/files
      - /root/static_files:/static_files:ro
      - ./config:/app/config
    env_file:
      - $CC_CONFIG_PATH/prod/global
      - $CC_CONFIG_PATH/prod/files
    restart: unless-stopped

  # subgraphs
  interfaces:
    # image: cc-interfaces:latest
    build: ./subgraphs/interfaces
    volumes:
      - subgraphs_data:/subgraphs
      - ./config:/app/config
    depends_on:
      - mongo
    env_file:
      - $CC_CONFIG_PATH/prod/global
      - $CC_CONFIG_PATH/prod/interfaces
    restart: unless-stopped

  clubs:
    # image: cc-clubs:latest
    build: ./subgraphs/clubs
    volumes:
      - subgraphs_data:/subgraphs
      - ./config:/app/config
    depends_on:
      - mongo
    env_file:
      - $CC_CONFIG_PATH/prod/global
    restart: unless-stopped

  members:
    # image: cc-members:latest
    build: ./subgraphs/members
    volumes:
      - subgraphs_data:/subgraphs
      - ./config:/app/config
    depends_on:
      - mongo
    env_file:
      - $CC_CONFIG_PATH/prod/global
    restart: unless-stopped

  events:
    # image: cc-events:latest
    build: ./subgraphs/events
    volumes:
      - subgraphs_data:/subgraphs
      - ./config:/app/config
    depends_on:
      - mongo
    env_file:
      - $CC_CONFIG_PATH/prod/global
    restart: unless-stopped

  users:
    # image: cc-users:latest
    build: ./subgraphs/users
    volumes:
      - subgraphs_data:/subgraphs
      - ./config:/app/config
    depends_on:
      - mongo
    env_file:
      - $CC_CONFIG_PATH/prod/global
    restart: unless-stopped
