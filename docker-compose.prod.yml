networks:
  cc-shared-network:
    external: true
    name: cc-prod-shared-network

volumes:
  subgraphs_data:

services:
  gateway:
    # image: cc-gateway:${IMAGE_TAG_GATEWAY:-latest}
    build: ./gateway
    volumes:
      - subgraphs_data:/subgraphs:ro
    env_file:
      - $CC_CONFIG_PATH/prod/global
      - $CC_CONFIG_PATH/prod/gateway
    environment:
      - NODE_ENV=production
    depends_on:
      - interfaces
      - clubs
      - members
      - events
      - users
    networks:
      - cc-shared-network
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:80/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})\""]
      interval: 10s
      timeout: 10s
      retries: 30
      start_period: 60s
    restart: unless-stopped

  web:
    image: cc-web:${IMAGE_TAG_WEB:-latest}
    # build:
    #   context: ./web
    env_file:
      - $CC_CONFIG_PATH/prod/global
      - $CC_CONFIG_PATH/prod/web
    networks:
      - cc-shared-network
    restart: unless-stopped

  auth:
    image: cc-auth:${IMAGE_TAG_AUTH:-latest}
    # build: ./apis/auth
    env_file:
      - $CC_CONFIG_PATH/prod/global
      - $CC_CONFIG_PATH/prod/auth
    volumes:
      - ./config:/app/config
    networks:
      - cc-shared-network
    restart: unless-stopped

  files:
    image: cc-files:${IMAGE_TAG_FILES:-latest}
    # build: ./apis/files
    volumes:
      - /mnt/share/files1:/files
      - /root/static_files:/static_files:ro
      - ./config:/app/config
    env_file:
      - $CC_CONFIG_PATH/prod/global
      - $CC_CONFIG_PATH/prod/files
    networks:
      - cc-shared-network
    restart: unless-stopped

  # subgraphs
  interfaces:
    image: cc-interfaces:${IMAGE_TAG_INTERFACES:-latest}
    # build: ./subgraphs/interfaces
    volumes:
      - subgraphs_data:/subgraphs
      - ./config:/app/config
    env_file:
      - $CC_CONFIG_PATH/prod/global
      - $CC_CONFIG_PATH/prod/interfaces
    networks:
      - cc-shared-network
    restart: unless-stopped

  clubs:
    image: cc-clubs:${IMAGE_TAG_CLUBS:-latest}
    # build: ./subgraphs/clubs
    volumes:
      - subgraphs_data:/subgraphs
      - ./config:/app/config
    env_file:
      - $CC_CONFIG_PATH/prod/global
    networks:
      - cc-shared-network
    restart: unless-stopped

  members:
    image: cc-members:${IMAGE_TAG_MEMBERS:-latest}
    # build: ./subgraphs/members
    volumes:
      - subgraphs_data:/subgraphs
      - ./config:/app/config
    env_file:
      - $CC_CONFIG_PATH/prod/global
    networks:
      - cc-shared-network
    restart: unless-stopped

  events:
    image: cc-events:${IMAGE_TAG_EVENTS:-latest}
    # build: ./subgraphs/events
    volumes:
      - subgraphs_data:/subgraphs
      - ./config:/app/config
    env_file:
      - $CC_CONFIG_PATH/prod/global
    networks:
      - cc-shared-network
    restart: unless-stopped

  users:
    image: cc-users:${IMAGE_TAG_USERS:-latest}
    # build: ./subgraphs/users
    volumes:
      - subgraphs_data:/subgraphs
      - ./config:/app/config
    env_file:
      - $CC_CONFIG_PATH/prod/global
    networks:
      - cc-shared-network
    restart: unless-stopped
